var js=new Class.create;js.prototype={statusInfo:{},WHHolderId:"",requestData:{ftId:{},pt:{},pis:{},whId:"",po:{id:"",pId:""}},aliasTypes:{},callbackIds:{registerPI:"",selectPT:"",checkWH:"",checkSN:""},initialize:function(e,t,n,r,i){this.callbackIds.searchFieldTask=t;this.callbackIds.updateTaskStatus=n;this.callbackIds.searchReturnedPart=r;this.callbackIds.balanceParts=i;this.WHHolderId=e},searchFieldTask:function(){var e={};if($F("txtTaskNo")===""){return alert("Please enter a Task No / Client Ref!")}bsuiteJs.postAjax(this.callbackIds.searchFieldTask,{txtTaskNo:$F("txtTaskNo")},{onLoading:function(){Modalbox.show("loading",{beforeLoad:function(){Modalbox.deactivate()},title:"finding field task, please be patient..."})},onComplete:function(t,n){try{e.result=bsuiteJs.getResp(n,false,true)}catch(r){alert(r);Modalbox.hide();return}if(e.result.ft.id===undefined||e.result.ft.id===null){alert("System Error: field task information missing!");Modalbox.hide();return}if(e.result.ft.errMsg!=undefined||e.result.ft.errMsg!=null){alert(e.result.ft.errMsg);Modalbox.hide();return}if(e.result.ft.updateFieldTaskPropertyOnFinish!=undefined&&e.result.ft.updateFieldTaskPropertyOnFinish==true){$("updateFieldTaskPropertyOnFinish").value=1}$("ftId").value=e.result.ft.id;$("currentStatus").value=e.result.ft.status;$("nextStatuses").value=e.result.ft.nextStatuses.join();$("statusInfo").value=Object.toJSON(e.result.ft.statusInfo);this.statusInfo=$F("statusInfo").evalJSON();pageJs.bindStatusList(e.result.ft.nextStatuses);$("resetPanel").removeClassName("hidden");$("searchTaskDiv").removeClassName("currentRow").addClassName("row");if($("currentStatus").value==this.statusInfo.scan){$("taskStatusDiv").removeClassName("hidden");$("serialNoDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("txtSerialNo").focus()}else{$("taskStatusDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("btnUpdateStatus").focus()}$("txtTaskNo").disabled=true;$("btnTaskNo").disabled=true;$("btnUpdateStatus").disabled=true;Modalbox.hide()}})},bindStatusList:function(e){var t="";if(Object.prototype.toString.call(e)==="[object Array]"){e.each(function(e){t+='<option value="'+e+'" '+">"+e+"</option>"})}$("taskStatusList").update(t)},updateStatusChange:function(){$("btnUpdateStatus").disabled=true;if($F("taskStatusList")!=$F("currentStatus")){$("btnUpdateStatus").disabled=false}},updateStatus:function(){var e={};e.taskNotes="";if($F("ftId")===""){return alert("Invalid Field Task ID")}this.statusInfo=$F("statusInfo").evalJSON();e.failed=false;if($F("taskStatusList")==this.statusInfo.fail){e.failed=true;e.taskNotes="";if($("parentStatusImg").src.indexOf("redbutton")!=-1){e.taskNotes+="\n\nThe returned part type, did not match the field task part type"}else{e.recipe=$("recipe").value.evalJSON();for(var t=0;t<e.recipe.length;t++){if(e.recipe[t].passed==false){e.taskNotes+="\n----------------------------------------------------------------------";e.taskNotes+="\nKit Part: "+e.recipe[t].pc+" ::: "+e.recipe[t].name;if(e.recipe[t].serialised){e.taskNotes+="\nReceived: "+e.recipe[t].found.ptInfo;e.taskNotes+="\nSerial No: "+e.recipe[t].found.serialNo+" ("+e.recipe[t].found.status+")"}else{e.taskNotes+="\nExpecting: "+e.recipe[t].qty+"\nReceived : "+(parseInt(e.recipe[t].found.good)+parseInt(e.recipe[t].found.notGood))+" (Good: "+e.recipe[t].found.good+", Not Good: "+e.recipe[t].found.notGood+")"}if(t==e.recipe.length-1){e.taskNotes+="\n----------------------------------------------------------------------"}}}}if(e.taskNotes!=""){e.taskNotes="The task has failed the BOM TEST for the following reason(s);\n\n"+"Returned Part: "+$("parentPiInfo").value+e.taskNotes;alert(e.taskNotes)}}else if($F("taskStatusList")==this.statusInfo.finish||$F("taskStatusList")==this.statusInfo.fail||$F("taskStatusList")==this.statusInfo.cancel){e.updateFtpPiId=false;if(($F("taskStatusList")==this.statusInfo.finish||$F("taskStatusList")==this.statusInfo.fail)&&$F("updateFieldTaskPropertyOnFinish")==1){e.updateFtpPiId=$F("parentPiId")}if(!confirm("Are you sure you want to update the status to "+$F("taskStatusList")+"?"))return}bsuiteJs.postAjax(this.callbackIds.updateTaskStatus,{ftId:$F("ftId"),status:$F("taskStatusList"),piId:$F("parentPiId"),taskNotes:e.taskNotes,updateFtpPiId:e.updateFtpPiId,failed:e.failed},{onLoading:function(){Modalbox.show("loading",{beforeLoad:function(){Modalbox.deactivate()},title:"updating task status, please be patient..."})},onComplete:function(t,n){try{e.result=bsuiteJs.getResp(n,false,true)}catch(r){alert(r);Modalbox.hide();return}if(e.result.ft.id===undefined||e.result.ft.id===null){alert("System Error: field task information missing!");Modalbox.hide();return}if(e.result.ft.errMsg!=undefined||e.result.ft.errMsg!=null){alert(e.result.ft.errMsg);Modalbox.hide();return}$("currentStatus").value=e.result.ft.status;$("nextStatuses").value=e.result.ft.nextStatuses.join();pageJs.bindStatusList(e.result.ft.nextStatuses);this.statusInfo=$F("statusInfo").evalJSON();if(e.result.ft.status==this.statusInfo.scan){$("taskStatusDiv").removeClassName("currentRow").addClassName("row");$("serialNoDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("taskStatusList").disabled=true;$("btnUpdateStatus").disabled=true;$("txtSerialNo").focus()}else if(e.result.ft.status==this.statusInfo.test){$$(".partsMatchDiv").each(function(e){e.removeClassName("hidden")});$("taskStatusDiv").removeClassName("currentRow").addClassName("row");$("recipeDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("taskStatusList").disabled=true;$("btnUpdateStatus").disabled=true;if($("btnFinishTest")&&$("parentStatusImg").src.indexOf("redbutton")!=-1)if($("btnFinishTest")){$("btnFinishTest").disabled=false}}else if($F("taskStatusList")==this.statusInfo.fail||$F("taskStatusList")==this.statusInfo.finish||$F("taskStatusList")==this.statusInfo.cancel){e.alertMsg="";if(e.result.ft.alertMsg!=undefined||e.result.ft.alertMsg!=""){e.alertMsg=e.result.ft.alertMsg+"\n\n"}alert(e.alertMsg+"This task ("+$F("ftId")+") can no longer be edited from this page, as the status is: "+$F("taskStatusList")+"\n\nThe page will now reload...");location.reload(true)}else{$("taskStatusDiv").removeClassName("currentRow").addClassName("row");$("serialNoDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("taskStatusList").disabled=true;$("btnUpdateStatus").disabled=true;$("btnSerialNo").focus()}Modalbox.hide()}})},searchReturnedPart:function(){var e={};if($F("txtSerialNo")===""){return alert("Please enter a serial no to search...")}bsuiteJs.postAjax(this.callbackIds.searchReturnedPart,{ftId:$F("ftId"),txtSerialNo:$F("txtSerialNo")},{onLoading:function(){Modalbox.show("loading",{beforeLoad:function(){Modalbox.deactivate()},title:"finding part instance, please be patient..."})},onComplete:function(t,n){$("registerEditPanel").addClassName("hidden");$("registerEditLink").stopObserving("click");try{e.result=bsuiteJs.getResp(n,false,true)}catch(r){alert(r);Modalbox.hide();if(r.indexOf("Unable to find a matching part instance for serial no")!=-1){$("registerEditLink").observe("click",function(){window.open("/registerparts");return false});$("registerEditLink").update("Register Part Instance");$("registerEditPanel").removeClassName("hidden")}else if(r.indexOf("Multiple part instances found for serial no")!=-1){$("registerEditLink").observe("click",function(){window.open("/reregisterparts");return false});$("registerEditLink").update("Edit Part Instance");$("registerEditPanel").removeClassName("hidden")}return}if(e.result.ft.id===undefined||e.result.ft.id===null){alert("System Error: field task information missing!");Modalbox.hide();return}if(e.result.ft.recipe===undefined||e.result.ft.recipe===null){alert("System Error: recipe information missing!");Modalbox.hide();return}Modalbox.hide();$("recipe").value=Object.toJSON(e.result.ft.recipe);if(e.result.ft.parentMatch==false){$("parentStatusImg").src=$("parentStatusImg").src.replace("greenbutton","redbutton");$("parentStatusImg").observe("mouseover",function(t){bsuiteJs.showTooltip(t,"toolTip","FAILED: "+e.result.ft.errMsg)})}else{for(var i=0;i<e.result.ft.recipe.length;i++){var s=e.result.ft.recipe[i];var o="&nbsp;";if(s.hp){o="<img src=\"/themes/images/red_flag_16.png\" onmouseover=\"bsuiteJs.showTooltip(event, 'toolTip', 'This is a high priority part...')\"/>"}var u="&nbsp;";if(s.serialised){u="<img src=\"/themes/images/s.gif\" onmouseover=\"bsuiteJs.showTooltip(event, 'toolTip', 'This is a serialised part...')\"/>"}e.html='<div class="recipeDisplayDiv">';e.html+='<table border="0" width="100%;" style="text-align:center; vertical-align:middle;">';e.html+="<tr>";e.html+='<td style="width:26px;">'+o+"</td>";e.html+='<td style="width:56px; font-weight:bold;"><div class="partCode">'+s.pc+"</div></td>";e.html+='<td style="width:26px;">'+u+"</td>";e.html+='<td style="text-align:center; padding-right:10px;" class="partName"><div>'+s.name+"</div></td>";e.html+='<td style="width:30px;"><img src="/themes/images/bluebutton.png" class="statusImg" onclick="pageJs.showCapturePanel(this, '+i+");\" onmouseover=\"bsuiteJs.showTooltip(event, 'toolTip', 'Click here to verify returned part...')\"/></td>";e.html+="<tr>";e.html+="</table>";e.html+="</div>";e.html+='<input type="hidden" value=\''+Object.toJSON(s)+"' />";if(s.serialised){e.html+='<div class="recipeCaptureDiv hidden">';e.html+='<table border="0" style="width:100%; text-align:center; vertical-align:middle;">';e.html+="<tr>";e.html+='<td style="width:26px;">'+o+"</td>";e.html+='<td style="width:56px; font-weight:bold;"><div class="partCode">'+s.pc+"</div></td>";e.html+='<td style="width:26px;">'+u+"</td>";e.html+='<td style="width:220px; text-align:right;"><b>Serial No:</b> <input type="text" class="serialCapture" style="width:100px;" onkeydown="pageJs.keyPressInput(event, this);" onkeyup="pageJs.keyUpInput(event, this);"/></td>';e.html+='<td style="text-align:right; padding-right:20px;"><b>Status:</b> <select onchange=""><option value="1">Good</option><option value="2">Not Good</option></select></td>';e.html+='<td style="width:30px;"><input type="button" value="Go" disabled onclick="pageJs.validateRecipePart(this);" /></td>';e.html+="<tr>";e.html+="</table>";e.html+="</div>"}else{e.html+='<div class="recipeCaptureDiv hidden">';e.html+='<table border="0" style="width:100%; text-align:center; vertical-align:middle;">';e.html+="<tr>";e.html+='<td style="width:26px;">'+o+"</td>";e.html+='<td style="width:56px; font-weight:bold;"><div class="partCode">'+s.pc+"</div></td>";e.html+='<td style="width:26px;">'+u+"</td>";e.html+='<td style="width:220px; text-align:right;"><b>Good Qty:</b> <input type="text" style="width:50px;" class="qtyCapture" onkeydown="pageJs.keyPressInput(event, this);" onkeyup="pageJs.keyUpInput(event, this);" /></td>';e.html+='<td style="text-align:right; padding-right:20px;"><b>Not Good Qty:</b> <input type="text" style="width:50px;" class="qtyCapture" onkeydown="pageJs.keyPressInput(event, this);" onkeyup="pageJs.keyUpInput(event, this);"/></td>';e.html+='<td style="width:30px;"><input type="button" value="Go" disabled onclick="pageJs.validateRecipePart(this); "/></td>';e.html+="<tr>";e.html+="</table>";e.html+="</div>"}$("recipeDiv").insert({bottom:(new Element("div",{"class":"partsMatchDiv roundedCorners hidden"})).update(e.html)})}}$("recipeDiv").insert({bottom:(new Element("div",{})).update('<div style="text-align:right; padding:2px 22px 0 0;"><input type="button" id="btnFinishTest" value="Finish Test" disabled onclick="pageJs.finishTest();"/></div>')});$("recipeDiv").removeClassName("hidden");for(var a in e.result.ft.parentInfo){$("parentPiId").value=a;var f=e.result.ft.parentInfo[a].split(":::");$("parentLbl").update(f[0]+"<br />"+f[1]);$("parentPiInfo").value="("+$F("txtSerialNo")+") "+f[0]+" ::: "+f[1];break}if(e.result.ft.bomMatch==false){$("bomMatchImg").removeClassName("hidden")}$("serialNoDiv").insert({after:$("taskStatusDiv").remove()});$("scanKitMsg").addClassName("hidden");$("txtSerialNo").disabled=true;$("btnSerialNo").disabled=true;$("serialNoDiv").removeClassName("currentRow").addClassName("row");$("taskStatusDiv").removeClassName("row").addClassName("currentRow");$("taskStatusList").disabled=false;$("taskStatusList").focus()}})},toggleIndicatorBtn:function(e,t){if(t){e.src="/themes/images/greenbutton.png"}else{e.src="/themes/images/redbutton.png"}},validateRecipePart:function(e){var t={};t.pass=true;t.msg="PASSED...";t.img=e.up(4).previous("div").down(3).next(3).down("img");t.ingredient=e.up(4).previous("input").value.evalJSON();t.recipe=$("recipe").value.evalJSON();for(var n=0;n<t.recipe.length;n++){if(t.recipe[n].ptId==t.ingredient.ptId){t.recipeIndex=n}}t.recipe[t.recipeIndex].found={};if(!t.ingredient.serialised){t.good=e.up().previous(1).down("input");t.notGood=e.up().previous().down("input");if(t.ingredient.qty>parseInt(t.good.value)+parseInt(t.notGood.value)){{t.pass=false;t.msg="FAILED: The quantities do not add up..."}}t.recipe[t.recipeIndex].passed=t.pass;t.img.observe("mouseover",function(e){bsuiteJs.showTooltip(e,"toolTip",t.msg)});pageJs.toggleIndicatorBtn(t.img,t.pass);pageJs.hideCapturePanels();t.recipe[t.recipeIndex].found.good=t.good.value;t.recipe[t.recipeIndex].found.notGood=t.notGood.value;$("recipe").value=Object.toJSON(t.recipe);pageJs.validateTestPass()}else{var r=e.up().previous(1).down("input").value;if(r===""){return alert("Please scan/enter serial no...")}bsuiteJs.postAjax(this.callbackIds.searchReturnedPart,{ftId:$F("ftId"),txtSerialNo:r,matchPartTypeId:t.ingredient.ptId},{onLoading:function(){Modalbox.show("loading",{beforeLoad:function(){Modalbox.deactivate()},title:"matching part instance, please be patient..."})},onComplete:function(n,r){$("registerEditPanel").addClassName("hidden");$("registerEditLink").stopObserving("click");try{t.result=bsuiteJs.getResp(r,false,true)}catch(i){alert(i);Modalbox.hide();if(i.indexOf("Unable to find a matching part instance for serial no")!=-1){$("registerEditLink").observe("click",function(){window.open("/registerparts");return false});$("registerEditLink").update("Register Part Instance");$("registerEditPanel").removeClassName("hidden")}else if(i.indexOf("Multiple part instances found for serial no")!=-1){$("registerEditLink").observe("click",function(){window.open("/reregisterparts");return false});$("registerEditLink").update("Edit Part Instance");$("registerEditPanel").removeClassName("hidden")}return}if(t.result.pi.id===undefined||t.result.pi.id===null){alert("System Error: part instance information missing!");Modalbox.hide();return}Modalbox.hide();if(t.result.pi.errMsg!=undefined||t.result.pi.errMsg!=null){t.pass=false;t.msg="FAILED: "+t.result.pi.errMsg}t.img.observe("mouseover",function(e){bsuiteJs.showTooltip(e,"toolTip",t.msg)});pageJs.toggleIndicatorBtn(t.img,t.pass);pageJs.hideCapturePanels();t.recipe[t.recipeIndex].found.piId=t.result.pi.id;t.recipe[t.recipeIndex].found.ptInfo=t.result.pi.ptInfo;t.recipe[t.recipeIndex].found.statusId=e.up().previous().down("select").value;t.sel=e.up().previous().down("select");t.recipe[t.recipeIndex].found.status=t.sel[t.sel.selectedIndex].text;t.recipe[t.recipeIndex].found.serialNo=t.result.pi.serialNo;t.recipe[t.recipeIndex].found.piId=t.result.pi.id;t.recipe[t.recipeIndex].passed=t.pass;$("recipe").value=Object.toJSON(t.recipe);pageJs.validateTestPass()}})}},balanceParts:function(){var e={};if($F($(this.WHHolderId))===""){return alert("Please select a warehouse location!")}bsuiteJs.postAjax(this.callbackIds.balanceParts,{whId:$F($(this.WHHolderId)),ftId:$F("ftId"),piId:$F("parentPiId"),recipe:$F("recipe")},{onLoading:function(){Modalbox.show("loading",{beforeLoad:function(){Modalbox.deactivate()},title:"balancing part(s), please be patient..."})},onComplete:function(t,n){try{e.result=bsuiteJs.getResp(n,false,true)}catch(r){alert(r);Modalbox.hide();return}if(e.result.ft.id===undefined||e.result.ft.id===null){alert("System Error: field task information missing!");Modalbox.hide();return}if(e.result.ft.errMsg!=undefined||e.result.ft.errMsg!=null){alert(e.result.ft.errMsg);Modalbox.hide();return}Modalbox.hide();alert("Successfully balanced, task notes added, please update the status accordingly...");$("treePanel").addClassName("hidden");$("taskStatusDiv").removeClassName("row").removeClassName("hidden").addClassName("currentRow");$("btnUpdateStatus").disabled=false;$("btnUpdateStatus").focus()}})},showCapturePanel:function(e,t){pageJs.hideCapturePanels();e.up("div").up("div").addClassName("currentPartsMatchDiv");e.up("div").addClassName("hidden");e.up("div").next("div").removeClassName("hidden");e.up("div").next("div").down("input").focus();$("registerEditPanel").style.top=Element.cumulativeOffset(e.up("div").up("div")).top-294+"px";$("registerEditPanel").addClassName("hidden")},hideCapturePanels:function(){$$(".recipeCaptureDiv").each(function(e){e.addClassName("hidden");e.up("div").removeClassName("currentPartsMatchDiv");e.previous("div").removeClassName("hidden")})},validateTestPass:function(){var e=false;$$(".recipeDisplayDiv").each(function(t){if(t.down(3).next(3).down("img").src.indexOf("bluebutton")!=-1){e=true}});$("btnFinishTest").disabled=e},finishTest:function(){var e=true;var t="The test has PASSED, please select a location from the tree and click 'Balance Parts'";var n=true;$("registerEditPanel").addClassName("hidden");if($("parentStatusImg").src.indexOf("redbutton")!=-1){n=false;t="The test has FAILED, please update the task status accordingly.\n\nThe additional task notes will be appended to reflect the test results."}else{$$(".recipeDisplayDiv").each(function(r){if(r.hasClassName("hidden")==false){if(r.down(3).next(3).down("img").src.indexOf("redbutton")!=-1){n=false;t="The test has FAILED, please update the task status accordingly.\n\nThe additional task notes will be appended to reflect the test results."}else if(r.down(3).next(3).down("img").src.indexOf("bluebutton")!=-1){alert("The test is not COMPLETED, please continue until all BLUE buttons are either RED or GREEN...");e=false}}else{alert("The test is not COMPLETED, please continue until all BLUE buttons are either RED or GREEN...");e=false}})}if(e==true){if(confirm("Are you sure you want to finish the test?\n\n"+t)){$("btnFinishTest").disabled=true;if(n){$("treePanel").removeClassName("hidden").removeClassName("row").addClassName("currentRow");$("balancePanel").removeClassName("row").addClassName("currentRow");$("taskStatusDiv").removeClassName("currentRow").addClassName("row");$("taskStatusList").disabled=false;$("taskStatusList").focus()}else{$("recipeDiv").insert({after:$("taskStatusDiv").remove()});$("taskStatusDiv").removeClassName("row").addClassName("currentRow");$("taskStatusList").disabled=false;$("taskStatusList").focus()}$("recipeDiv").removeClassName("currentRow").addClassName("row");$$(".recipeDisplayDiv").each(function(e){e.down(3).next(3).down("img").cursor="default";e.down(3).next(3).down("img").onclick=null})}}},keyPressInput:function(e,t){if(!(e.which&&e.which==13||e.keyCode&&e.keyCode==13)){return true}if(t.id=="txtTaskNo"){if(t.value==""){alert("Please enter a Task No / Client Ref!");return}$("btnTaskNo").click()}else if(t.id=="txtSerialNo"){if(t.value==""){alert("Please scan/enter a serial no...");return}$("btnSerialNo").click()}else if(t.hasClassName("serialCapture")){if(t.value==""){alert("Please scan/enter a serial no...");return}t.up().next(1).down("input").click()}else if(t.hasClassName("qtyCapture")){if(!t.value.match(/^[0-9][0-9]*$/)){alert("Please enter a valid quantity...");return}var n=t.up().next().down("input");if(n&&n.type=="button"){n.click()}else{t.up().next().down("input").focus()}}},keyUpInput:function(e,t){if(!(e.which&&e.which==13||e.keyCode&&e.keyCode==13)){if(t.hasClassName("serialCapture")){if(t.value==""){t.up().next(1).down("input").disabled=true}else{t.up().next(1).down("input").disabled=false}}else if(t.hasClassName("qtyCapture")){var n=t.up().next().down("input");if(n&&n.type=="button"){var r=t.up().previous().down("input");var i=t}else{var r=t;var i=t.up().next().down("input");var n=t.up().next(1).down("input")}if(r.value.match(/^[0-9][0-9]*$/)&&i.value.match(/^[0-9][0-9]*$/)){n.disabled=false}else{n.disabled=true}}}},modal:function(){var e={};e.html='<div process="header">Processing: <span process="currIndex">1</span> / <span process="total">dszhgxdgh</span> part instance(s)</div>';e.html+='<div process="errors" style="height: 400px;overflow: auto;">';e.html+='<table class="DataList">';e.html+="<thead><tr><td>Barcode</td><td>Error</td></tr></thead><tbody></tbody>";e.html+="</table>";e.html+="</div>";Modalbox.show((new Element("div")).update(e.html),{beforeLoad:function(){},afterLoad:function(){},transitions:false,title:'<b class="manD">Processing Part Instances, please DO NOT close or REFRESH the browser!</b>'})},resetPage:function(){if(confirm("Are you sure you want to reload the page, all data will be lost?")){location.reload()}}}