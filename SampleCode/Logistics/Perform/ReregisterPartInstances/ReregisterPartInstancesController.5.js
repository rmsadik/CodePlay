var EditPIJS=new Class.create();EditPIJS.prototype={callBackIds:{},isCurrUsrSysAdmin:false,snAliasTypeId:null,editPIPanelID:"",aliasPanelID:"",partinstance:null,searchBarcodeTxtboxID:null,searchPiIdTxtboxID:null,searchBtnID:null,initialize:function(a,b,d,g,c,e,f){this.isCurrUsrSysAdmin=(a==="1"?true:false);this.snAliasTypeId=b;this.editPIPanelID=d;this.aliasPanelID=g;this.searchBarcodeTxtboxID=c;this.searchPiIdTxtboxID=e;this.searchBtnID=f},setCallbackIds:function(c,a,b,d){this.callBackIds.getPIBtn=c;this.callBackIds.changePTBtn=a;this.callBackIds.chkConflictBtn=b;this.callBackIds.savePIBtn=d;return this},openHistory:function(){if(this.partinstance===undefined||this.partinstance===null||this.partinstance.id===undefined||this.partinstance.id===null){alert("System Error: the part instance id not stored!");return}window.open("/parthistory/searchparttext/"+this.partinstance.id)},getPI:function(b){var a={};a.me=this;a.originalValue=$F(b);a.btnDisabled=$(b).disabled;$(a.me.searchBarcodeTxtboxID).value=$F(a.me.searchBarcodeTxtboxID).strip().toUpperCase();a.searchData={};$(b).up(".searchpane").getElementsBySelector("[searchpane]").each(function(c){a.searchData[$(c).readAttribute("searchpane")]=$F(c)});bsuiteJs.postAjax(a.me.callBackIds.getPIBtn,a.searchData,{onLoading:function(c,d){$(b).value="Retrieving PI Info";$(b).disabled=true;a.me.partinstance=null;$$(".resetWhenChangePT").each(function(e){e.update("")});$$(".editPIDetails").each(function(e){e.addClassName("hidden")});$(a.me.searchPiIdTxtboxID).value="";if($("HotMessage")&&$("HotMessage").up()){$("HotMessage").up().update("")}},onComplete:function(c,f){try{a.result=bsuiteJs.getResp(f,false,true);if(a.result.piArray===undefined||a.result.piArray===null||a.result.piArray.size()===0){throw"No part instance found from the search!"}if(a.result.piArray.size()>1){a.me._showMultiplePI(a.result.piArray)}else{a.me.partinstance=a.result.piArray[0];if(a.me.partinstance.parttype.serialized!==true){throw"You can NOT edit a non-serialised part instance here!"}a.me._showPIDetails(a.me.partinstance);if($(b).up().down(".viewHistoryBtn")===undefined||$(b).up().down(".viewHistoryBtn")===null){$(b).insert({after:new Element("span",{"class":"viewHistoryBtn inlineblock"}).update("View History").observe("click",function(){a.me.openHistory()})})}$$(".editPIDetails.hidden").each(function(e){e.removeClassName("hidden")});$("searchbarcode").value=a.me.partinstance.sn;$("newbarcode").focus()}$(b).value=a.originalValue;$(b).disabled=a.btnDisabled}catch(d){alert(d);$(b).value=a.originalValue;$(b).disabled=a.btnDisabled}}});return this},changePT:function(a){var b={};b.me=this;$(a).getElementsBySelector("li.selected").each(function(c){b.ptId=c.value});bsuiteJs.postAjax(b.me.callBackIds.changePTBtn,{piId:b.me.partinstance.id,ptId:b.ptId},{onLoading:function(c,d){$$(".resetWhenChangePT").each(function(e){$(e).update("Retrieving PartType Information ...")})},onComplete:function(c,f){try{b.result=bsuiteJs.getResp(f,false,true);if(b.result.piArray===undefined||b.result.piArray===null||b.result.piArray.size()===0){throw"No part instance found from the search!"}b.me._showPIDetails(b.result.piArray[0])}catch(d){alert(d)}}})},_showPIDetails:function(b){var a={};a.Qty=null;a.active=null;a.me=this;$(a.me.searchPiIdTxtboxID).value=b.id;$$('[editpane="parttype"]').each(function(c){c.writeAttribute("ptid",b.parttype.id);c.writeAttribute("serialized",b.parttype.serialized===true?1:0);c.value=b.parttype.name});a.contractsList=new Element("ul");b.contracts.each(function(c){a.contractsList.insert({bottom:new Element("li").update(c.name)})});if(a.me.isCurrUsrSysAdmin!==true){if(this.partinstance.active===0){alert("This part instance is deactivated.\n Please contact technology if you want to reactivate it")}a.editPIPanel=$(a.me.editPIPanelID).update("").insert({bottom:a.me._getRowDiv("Owner Client: ",b.owner.name)}).insert({bottom:a.me._getRowDiv("User Contract(s): ",a.contractsList.wrap(new Element("div",{"class":"contractlist roundcnr"})))}).insert({bottom:a.me._getRowDiv("Part Location: ",b.warehouse.path)}).insert({bottom:a.me._getRowDiv("Status: ",a.me._getSelectBox(b.status.availStatuses.sort(),"id","name",b.status.id).writeAttribute("editpane","status"))}).insert({bottom:a.me._getRowDiv("Qty: ",b.qty)}).insert({bottom:a.me._getRowDiv("Active: ",b.active===1?"Yes":"No")});a.newBarcode=null;if(b.parttype.serialized===true){a.newBarcode=new Element("input",{id:"newbarcode",type:"text",editpane:"newbarcode","class":"clearonreset roundcnr txt fullwidth",placeholder:"The new serial number",value:""}).observe("keydown",function(c){return a.me.keydown(c,function(){a.emtpyAliasInputs=$$('[editpane="alias"]').filter(function(d){return $F(d).blank()});if(a.emtpyAliasInputs.size()>0){a.emtpyAliasInputs.first().focus()}})});a.editPIPanel.insert({bottom:a.me._getRowDiv("New Serial Number: ",new Element("div").update(a.newBarcode).insert({bottom:a.me._getSampleFormatDiv(b.snFormats.pattern,b.snFormats.sampleformat)}),a.me._getRowErrMsg("Leave blank to retain current Serial Number","infomsg"))})}if(b.aliases!==null&&this.partinstance.active===1){$(a.me.aliasPanelID).update(a.me._getAliasDiv(b.aliases,b.avialPIATs)).insert({bottom:new Element("input",{type:"button",value:"Save",id:"savePIBtn"}).observe("click",function(){a.me.savePI()})})}}else{a.Qty=new Element("input",{id:"qty",type:"text",editpane:"qty","class":"clearonreset roundcnr txt fullwidth",placeholder:"qty",value:b.qty});a.active=new Element("input",{id:"active",type:"text",editpane:"active","class":"clearonreset roundcnr txt fullwidth",placeholder:"active",value:b.active});a.editPIPanel=$(a.me.editPIPanelID).update("").insert({bottom:a.me._getRowDiv("Owner Client: ",b.owner.name)}).insert({bottom:a.me._getRowDiv("User Contract(s): ",a.contractsList.wrap(new Element("div",{"class":"contractlist roundcnr"})))}).insert({bottom:a.me._getRowDiv("Part Location: ",b.warehouse.path)}).insert({bottom:a.me._getRowDiv("Status: ",a.me._getSelectBox(b.status.availStatuses.sort(),"id","name",b.status.id).writeAttribute("editpane","status"))}).insert({bottom:a.me._getRowDiv("Qty: ",new Element("div").update(a.Qty).insert(),a.me._getRowErrMsg("Qty should be 1","infomsg"))}).insert({bottom:a.me._getRowDiv("Active: ",new Element("div").update(a.active).insert(),a.me._getRowErrMsg("Activate: 1 | Deactivate : 0","infomsg"))});a.newBarcode=null;if(b.parttype.serialized===true){a.newBarcode=new Element("input",{id:"newbarcode",type:"text",editpane:"newbarcode","class":"clearonreset roundcnr txt fullwidth",placeholder:"The new serial number",value:""}).observe("keydown",function(c){return a.me.keydown(c,function(){a.emtpyAliasInputs=$$('[editpane="alias"]').filter(function(d){return $F(d).blank()});if(a.emtpyAliasInputs.size()>0){a.emtpyAliasInputs.first().focus()}})});a.editPIPanel.insert({bottom:a.me._getRowDiv("New Serial Number: ",new Element("div").update(a.newBarcode).insert({bottom:a.me._getSampleFormatDiv(b.snFormats.pattern,b.snFormats.sampleformat)}),a.me._getRowErrMsg("Leave blank to retain current Serial Number","infomsg"))})}if(b.aliases!==null){$(a.me.aliasPanelID).update(a.me._getAliasDiv(b.aliases,b.avialPIATs)).insert({bottom:new Element("input",{type:"button",value:"Save",id:"savePIBtn"}).observe("click",function(){a.me.savePI()})})}}},_getRowErrMsg:function(c,b){var a={};a.classname=(b===undefined||b===null)?"":b;a.element=new Element("span",{"class":"msg smltxt "+a.classname}).update(c);return a.element},savePI:function(){var a={};a.me=this;a.newData=this._collectingData();if(a.newData===null){return}a.me._getDiffFromCollectedData(a.newData)},_getCfrmDivRow:function(e,c,a,d,f){var b={};b.element=new Element("div",{"class":"aliastyperow "+(f===true?"header":"cfrmChgRow")}).insert({bottom:new Element("span",{"class":"inlineblock actiontype"}).update(c)}).insert({bottom:new Element("span",{"class":"inlineblock field"}).update(e)}).insert({bottom:new Element("span",{"class":"inlineblock oldValue"}).update(a)}).insert({bottom:new Element("span",{"class":"inlineblock newValue"}).update(d)});return b.element},_getDiffFromCollectedData:function(b){var a={};a.me=this;a.diffs=[];if(b.parttype.id!==a.me.partinstance.parttype.id){a.diffs.push({field:"Part Type",action:"Updating",oldValue:a.me.partinstance.parttype.name,newValue:b.parttype.name})}if(b.status.id!==a.me.partinstance.status.id){a.diffs.push({field:"Status",action:"Updating",oldValue:a.me.partinstance.status.name,newValue:b.status.name})}if(a.me.isCurrUsrSysAdmin===true){if(b.qty!==a.me.partinstance.qty){a.diffs.push({field:"Qty",action:"Updating",oldValue:a.me.partinstance.qty,newValue:b.qty})}if(b.active==a.me.partinstance.active){}else{a.diffs.push({field:"Active",action:"Updating",oldValue:a.me.partinstance.active,newValue:b.active})}}$H(b.aliases).each(function(c){a.typeId=c.key;if(a.me.partinstance.aliases[a.typeId]===undefined||a.me.partinstance.aliases[a.typeId]===null){c.value.each(function(d){a.diffs.push({field:a.me.partinstance.avialPIATs[a.typeId].name,action:"Creating",oldValue:"",newValue:d.alias})})}else{c.value.each(function(d){if(d.id.blank()){a.diffs.push({field:a.me.partinstance.avialPIATs[a.typeId].name,action:"Creating",oldValue:"",newValue:d.alias})}else{if(d.deactivate===true){a.diffs.push({field:a.me.partinstance.avialPIATs[a.typeId].name,action:"Removing",oldValue:d.alias,newValue:""})}else{a.me.partinstance.aliases[a.typeId].each(function(e){if(d.id===e.id&&d.alias!==e.alias){a.diffs.push({field:a.me.partinstance.avialPIATs[a.typeId].name,action:"Updating",oldValue:e.alias,newValue:d.alias})}})}}})}});if(a.diffs.size()===0){alert("Nothing changed!");return}a.confirmChangeDiv=new Element("div",{"class":"cfrmChgDiv"}).update(a.me._getCfrmDivRow("Field","Action","Old Value","New Value",true));a.rowNo=0;a.editPIChgSummary=[];a.diffs.each(function(c){a.editPIChgSummary.push(c.action+" "+c.field+": ["+c.oldValue+"] -> ["+c.newValue+"]");a.confirmChangeDiv.insert({bottom:a.me._getCfrmDivRow(c.field,c.action,c.oldValue,c.newValue,false).addClassName(((a.rowNo++)%2===0?"even":"odd"))})});Modalbox.show(a.confirmChangeDiv.wrap("div"),{title:"Are you sure you want to change this part instance:",width:600,afterLoad:function(){$(Modalbox.MBcontent).insert({top:new Element("div",{"class":"submitPIBtns"}).insert({bottom:new Element("input",{value:"Yes",type:"button","class":"submitBtn"}).observe("click",function(){a.me._chkConflicts(b,a.editPIChgSummary)})}).insert({bottom:new Element("input",{value:"No",type:"button","class":"submitBtn"}).observe("click",function(){Modalbox.hide()})})});Modalbox.resizeToContent()}})},_chkConflicts:function(c,a){var b={};b.me=this;bsuiteJs.postAjax(b.me.callBackIds.chkConflictBtn,c,{onLoading:function(d,e){Modalbox.show("loading",{title:"Checking whether there are conflicts against unique aliases ..."})},onComplete:function(d,g){try{b.result=bsuiteJs.getResp(g,false,true);if(b.result.confictsPIATIds===undefined||b.result.confictsPIATIds===null||b.result.confictsPIATIds.size()===0){b.me._submitPI(c,a);return}b.me._displayConflicts(c,b.result.confictsPIATIds,b.result.conficts,a)}catch(f){alert(f)}}});return this},_displayConflicts:function(e,a,b,c){var d={};d.me=this;d.avialPIATs=this.partinstance.avialPIATs;d.conflictDiv=new Element("div",{"class":"conflictDiv"}).update(d.me._getConflictPIR("","S/N","Part Type","Location","Conflicted Aliases").addClassName("header"));d.rowNo=0;d.currPi=d.me.partinstance;d.currAliases={};$H(e.aliases).each(function(f){d.typeId=f.key;d.aliasObj=f.value;if(a.indexOf(d.typeId)>=0){if(d.currAliases[d.typeId]===undefined||d.currAliases[d.typeId]===null){d.currAliases[d.typeId]=[]}d.aliasObj.each(function(g){if(g.deactivate===false){d.aliasContent=g.alias;d.currAliases[d.typeId].push(d.aliasContent)}})}});d.conflictDiv.insert({bottom:d.me._getConflictPIRow(d.currPi.id,d.currPi.sn+((e.newbarcode&&!e.newbarcode.blank())?" -> "+e.newbarcode:""),'<div class="smltxt errormsg currenteditpi">Currently being Edited</div> '+e.parttype.name,d.currPi.warehouse.path,d.currAliases,a,d.currPi.parent).addClassName((d.rowNo++)%2===0?"even":"odd")});d.samePT=true;d.sameParent=true;$H(b).each(function(f){d.piId=f.key;d.confAArray=f.value;d.conflictDiv.insert({bottom:d.me._getConflictPIRow(d.piId,d.confAArray.pi.sn,d.confAArray.pi.name,d.confAArray.pi.warehouse.path,d.confAArray.aliases,a,d.confAArray.pi.parent).addClassName((d.rowNo++)%2===0?"even":"odd")});if(e.parttype.id!==d.confAArray.pi.parttype.id){d.samePT=false}if(d.currPi.parent.id!==d.confAArray.pi.parent.id){d.sameParent=false}});Modalbox.show(d.conflictDiv,{width:"900",title:'<span style="color: red;">Conflicts found! Please select <u>ONE</u> PartInstance to <u>KEEP</u>!</span>',afterLoad:function(){d.conflictedPIIds={};$(Modalbox.MBcontent).getElementsBySelector(".conflictAliasRow[partinstanceid] .piraidobtn input").each(function(f){d.piId=f.value;d.conflictedPIIds[d.piId]=false;f.observe("click",function(){if(d.samePT===false){alert("To merge part instances, they have to be the same part type. but they are NOT! Please edit the part instance first!");return}if(d.sameParent===false){alert("To merge part instances, they have to be either under the same parent OR under no parent at all!");return}d.conflictedPIIds[$F(this)]=true;if(confirm("Are you sure you want to merge all other PI into the selected one?")){d.me._submitPI(e,c,d.conflictedPIIds)}})});Modalbox.resizeToContent()}});return this},_getConflictPIRow:function(f,d,g,b,c,a,h){var e={};e.avialPIATs=this.partinstance.avialPIATs;e.conflictRowAlias=new Element("div",{"class":"conflictAlias"});$H(c).each(function(i){e.aliasTypeId=i.key;e.aliases=i.value;e.conflictRowAlias.insert({bottom:new Element("div",{"class":"conflictAlias"}).insert({bottom:new Element("span",{"class":"conflictAliasType inlineblock"}).update(e.avialPIATs[e.aliasTypeId].name+": ")}).insert({bottom:new Element("span",{"class":"conflictAliasContent inlineblock"}).update(e.aliases.join("<br />"))})})});return this._getConflictPIR(f,d,g,b,e.conflictRowAlias,h)},_getConflictPIR:function(c,b,e,a,d,f){return new Element("div",{"class":"aliastyperow conflictAliasRow ",partinstanceid:c}).insert({bottom:new Element("span",{"class":"piraidobtn inlineblock"}).update((!c||c.blank())?"":new Element("input",{type:"radio",name:"conflictedpi",value:c}))}).insert({bottom:new Element("span",{"class":"pisn inlineblock"}).update(b)}).insert({bottom:new Element("span",{"class":"piname inlineblock"}).update(e)}).insert({bottom:new Element("span",{"class":"pilocation inlineblock"}).update((f&&f.id?'<div class="smltxt errormsg">Within another Part</div> ':"")+a)}).insert({bottom:new Element("span",{"class":"pialiasconflicts inlineblock"}).update(d)})},_submitPI:function(d,a,c){var b={};b.me=this;d.editPIChgSummary=a;d.conflictedPIIds=c;bsuiteJs.postAjax(b.me.callBackIds.savePIBtn,d,{onLoading:function(e,f){Modalbox.show("loading",{title:"Saving part instance ..."})},onComplete:function(f,h){try{b.result=bsuiteJs.getResp(h,false,true);if(b.result.piArray!==undefined&&b.result.piArray!==null&&b.result.piArray.size()>0){alert("Part Instance Saved Successfully!");window.location.reload()}}catch(g){Modalbox.hide();alert(g)}}});return this},_reloadPIDetails:function(a,b){$(this.searchPiIdTxtboxID).value=a;if(b!==undefined&&b!==null){$(this.searchBarcodeTxtboxID).value=b}this.getPI($(this.searchBtnID))},_collectingData:function(){var a={};a.me=this;a.requestData={id:a.me.partinstance.id,parttype:{},status:{},aliases:{},avialPIATs:a.me.partinstance.avialPIATs};$$(".errorRow").each(function(b){b.removeClassName("errorRow")});a.hasErr=false;$$("[editpane]").each(function(b){switch(b.readAttribute("editpane")){case"parttype":a.requestData.parttype={id:b.readAttribute("ptid"),name:$F(b),serialized:(b.readAttribute("serialized")==1?true:false)};break;case"qty":if($F(b)=="1"){}else{a.row=$(b).up(".row");a.infoDiv=a.row.down(".info");a.infoDiv.update(a.me._getRowErrMsg(" Error!  Qty can only be 1"));a.hasErr=true;$(b).up(".row").addClassName("errorRow")}a.requestData.qty=$F(b);break;case"active":if($F(b)=="0"||$F(b)=="1"){}else{a.row=$(b).up(".row");a.infoDiv=a.row.down(".info");a.infoDiv.update(a.me._getRowErrMsg(" Error!  You can only use 1 or 0 to Activate or Deactivate a part"));a.hasErr=true;$(b).up(".row").addClassName("errorRow")}a.requestData.active=$F(b);break;case"status":a.requestData.status={id:$F(b),name:b.options[b.selectedIndex].innerHTML};break;case"newbarcode":a.newSerialNo=$F(b).strip().toUpperCase();a.oldSerialNo=$F(a.me.searchBarcodeTxtboxID).strip().toUpperCase();a.row=$(b).up(".row");a.infoDiv=a.row.down(".info");a.regexHolder=a.row.down("[pattern]");a.row.getElementsBySelector(".errormsg").each(function(c){c.remove()});a.regex=(a.regexHolder!==undefined&&a.regexHolder!==null&&!a.regexHolder.readAttribute("pattern").blank())?a.regexHolder.readAttribute("pattern"):"";if(a.newSerialNo.blank()){if(a.regex!==""&&a.me._matchPatter(a.oldSerialNo,a.regex)!==true){a.infoDiv.update(a.me._getRowErrMsg("You need to change the Serial Number!","errormsg"));a.hasErr=true;$(b).up(".row").addClassName("errorRow")}}else{if(a.newSerialNo===a.oldSerialNo){a.infoDiv.update(a.me._getRowErrMsg("New serial number cannot be same as current serial number!","errormsg"));a.hasErr=true;$(b).up(".row").addClassName("errorRow")}else{if(a.regex!==""&&a.me._matchPatter(a.newSerialNo,a.regex)!==true){a.infoDiv.update(a.me._getRowErrMsg("Invalid Serial Number provided!","errormsg"));a.hasErr=true;$(b).up(".row").addClassName("errorRow")}}}if(a.hasErr===false&&a.newSerialNo.blank()===false){if(a.requestData.aliases[a.me.snAliasTypeId]===undefined||a.requestData.aliases[a.me.snAliasTypeId]===null){a.requestData.aliases[a.me.snAliasTypeId]=[]}a.me.partinstance.aliases[a.me.snAliasTypeId].each(function(c){a.requestData.aliases[a.me.snAliasTypeId].push(a.me._newAliasObj(c.id,c.typeid,c.alias,true))});a.requestData.aliases[a.me.snAliasTypeId].push(a.me._newAliasObj("",a.me.snAliasTypeId,a.newSerialNo,false))}a.requestData.newbarcode=a.newSerialNo;break;case"alias":a.row=$(b).up(".row.alias");a.del=a.row.readAttribute("delete");a.typeId=a.row.readAttribute("typeid");a.regexHolder=a.row.down("[pattern]");a.regex=(a.regexHolder!==undefined&&a.regexHolder!==null&&!a.regexHolder.readAttribute("pattern").blank())?a.regexHolder.readAttribute("pattern"):"";a.alias=$F(b).strip();a.infoDiv=a.row.down(".info");a.row.getElementsBySelector(".errormsg").each(function(c){c.remove()});if(a.alias.blank()){a.infoDiv.insert({bottom:a.me._getRowErrMsg("Empty alias not allowed!","errormsg")});a.hasErr=true;$(b).up(".row").addClassName("errorRow")}else{if(a.me._matchPatter(a.alias,a.regex)===false){a.infoDiv.insert({bottom:a.me._getRowErrMsg("Alias NOT matched with Valid Format!","errormsg")});a.hasErr=true;$(b).up(".row").addClassName("errorRow")}else{if(a.requestData.aliases[a.typeId]===undefined||a.requestData.aliases[a.typeId]===null||a.requestData.aliases[a.typeId]===""){a.requestData.aliases[a.typeId]=[]}a.requestData.aliases[a.typeId].push(a.me._newAliasObj(a.row.readAttribute("piaid"),a.row.readAttribute("typeid"),a.alias,(a.del===undefined||a.del===null?false:true)))}}break}});a.collectedSerialNo=(a.requestData.aliases[a.me.snAliasTypeId]!==undefined&&a.requestData.aliases[a.me.snAliasTypeId]!==null&&a.requestData.aliases[a.me.snAliasTypeId].size()>0);if(a.requestData.parttype.serialized===false){if(a.collectedSerialNo){a.size=a.me.partinstance.aliases[a.me.snAliasTypeId].size();for(a.i=0;a.i<a.size;a.i++){a.me.partinstance.aliases[a.me.snAliasTypeId][a.i].deactivate=false}}else{a.requestData.aliases[a.me.snAliasTypeId]=[];a.me.partinstance.aliases[a.me.snAliasTypeId].each(function(b){b.deactivate=true;a.requestData.aliases[a.me.snAliasTypeId].push(b)})}}else{if(a.requestData.parttype.serialized===true&&a.collectedSerialNo===false){a.requestData.aliases[a.me.snAliasTypeId]=a.me.partinstance.aliases[a.me.snAliasTypeId]}}if(a.hasErr===true){alert("Error when saving, please fixing them before continue.")}return a.hasErr===true?null:a.requestData},_newAliasObj:function(d,a,b,c){return{id:d,typeid:a,alias:b,deactivate:(c===true?true:false)}},_matchPatter:function(a,b){if(b===undefined||b===null||b.blank()){return true}return new RegExp(b.substr(1,(b.length-2))).match(a)},addAliasType:function(b,c){var a={};a.me=this;a.usedAliasTypeIds=[];$(a.me.aliasPanelID).getElementsBySelector(".row.alias[typeid]").each(function(d){a.usedAliasTypeIds.push(d.readAttribute("typeid"))});a.usedAliasTypeIds=a.usedAliasTypeIds.uniq();a.aliasTypes=[];$H(c).each(function(d){a.typeId=d.key;a.piat=d.value;if(d.value.allowMulti===true||a.usedAliasTypeIds.indexOf(a.typeId)<0){if(d.value.access==="1"||(a.me.isCurrUsrSysAdmin===true&&d.value.access==="2")){a.aliasTypes.push(d.value)}}});a.typeList=new Element("div",{"class":"newaliastypelist"}).update(a.me._getAliasTypeRow("header aliastyperow","","Name","Allow Multiple","Is Mandatory","Is Unique","Sample Format"));a.rowNo=0;a.aliasTypes.each(function(d){a.typeList.insert({bottom:a.me._getAliasTypeRow("aliastyperow "+((a.rowNo++)%2===0?"even":"odd"),d.id,d.name,(d.allowMulti===true?"Y":"&nbsp;"),(d.mandatory===true?"Y":"&nbsp;"),(d.unique===true?"Y":"&nbsp;"),d.sampleformat)})});Modalbox.show(a.typeList.wrap("div"),{width:600,title:"Please select a alias type from below: ",afterLoad:function(){$(Modalbox.MBwindow).getElementsBySelector(".aliastyperow[piatid]").each(function(d){d.observe("click",function(){a.me.addAlias(d.readAttribute("piatid"))})})}})},addAlias:function(a){var b={};b.me=this;b.aliasTypes=b.me.partinstance.avialPIATs;b.newAliasTextBox=b.me._getAliasEditBox();$(this.aliasPanelID).down(".aliaslist").insert({bottom:b.me._getAliasRow("",b.aliasTypes[a].name,a,b.newAliasTextBox,b.me._getAliasDelBtn(),b.aliasTypes[a].pattern.pattern,b.aliasTypes[a].pattern.sampleformat)});Modalbox.hide({afterHide:function(){b.newAliasTextBox.focus()}})},_getAliasEditBox:function(a,c){var b={};b.me=this;b.aliasContent=((a!==undefined&&a!==null&&!a.blank())?a:"");b.placehoder=((c!==undefined&&c!==null&&!c.blank())?c:"");b.element=new Element("input",{"class":"clearonreset roundcnr txt fullwidth",value:b.aliasContent,type:"text",editpane:"alias"}).observe("keydown",function(d){b.me.keydown(d,function(){b.emtpyAliasInputs=$$('[editpane="alias"]').filter(function(e){return $F(e).blank()});if(b.emtpyAliasInputs.size()>0){b.emtpyAliasInputs.first().focus()}else{$(b.me.aliasPanelID).down("#savePIBtn").click()}})});if(b.placehoder!==""){b.element.writeAttribute("placeholder",b.placehoder)}return b.element},_getAliasTypeRow:function(e,h,b,a,f,g,d){var c={};c.cssclass=(e===undefined||e===null)?"row":e;c.element=new Element("div",{"class":c.cssclass}).update(new Element("span",{"class":"name inlineblock"}).update(b)).insert({bottom:new Element("span",{"class":"allowmulti inlineblock"}).update(a)}).insert({bottom:new Element("span",{"class":"mandatory inlineblock"}).update(f)}).insert({bottom:new Element("span",{"class":"unique inlineblock"}).update(g)}).insert({bottom:new Element("span",{"class":"sampleformat inlineblock"}).update(d)});if(h!==undefined&&h!==null&&!h.blank()){c.element.writeAttribute("piatid",h)}return c.element},_getAliasDelBtn:function(){var a={};a.me=this;return new Element("span",{"class":"delBtn"}).update("&nbsp;").observe("click",function(){if(!confirm("Are you sure you want to delete this alias?")){return}a.aliasRow=$(this).up(".row.alias");if(a.aliasRow.readAttribute("piaid").blank()){a.aliasRow.remove()}else{$(this).up(".row.alias").writeAttribute("delete",true).hide()}})},_getAliasDiv:function(a,c){var b={};b.me=this;b.element=new Element("fieldset",{"class":"aliaslist roundcnr"}).update(new Element("legend").update("Aliases")).insert({bottom:new Element("div").insert({bottom:new Element("input",{"class":"addAliasBtn",type:"button",value:"Add Alias"}).observe("click",function(){b.me.addAliasType(this,c)})}).insert({bottom:new Element("span",{"class":"manhint"}).update("* Mandatory Field")})});b.manTypeIds=[];b.unqiueTypeIds=[];$H(c).each(function(d){if(d.value.mandatory===true){b.manTypeIds.push(d.value.id)}if(d.value.unique===true){b.unqiueTypeIds.push(d.value.id)}});$H(a).each(function(d){b.aliasTypeId=d.key;b.index=b.manTypeIds.indexOf(b.aliasTypeId);b.isMand=false;if(b.index>=0){b.manTypeIds.splice(b.index,1);b.isMand=true}b.index=b.unqiueTypeIds.indexOf(b.aliasTypeId);b.isUniq=false;if(b.index>=0){b.unqiueTypeIds.splice(b.index,1);b.isUniq=true}d.value.each(function(e){b.aliastypebox=c[b.aliasTypeId].name+(b.isMand===true?' <span class="manhint">*</span>':"")+": ";b.aliastxtbox=e.alias+(b.aliasTypeId===b.me.snAliasTypeId?"":'<input type="hidden" editpane="alias" value="'+e.alias+'" />');b.aliasbtns=new Element("span");b.pattern="";b.sampleformat="";if(c[b.aliasTypeId].access==="1"||(c[b.aliasTypeId].access==="2"&&b.me.isCurrUsrSysAdmin===true)){b.aliastxtbox=b.me._getAliasEditBox(e.alias);b.pattern=c[b.aliasTypeId].pattern.pattern;b.sampleformat=c[b.aliasTypeId].pattern.sampleformat;if(b.isMand!==true){b.aliasbtns.insert({bottom:b.me._getAliasDelBtn()})}if(b.isUniq===true){b.aliasbtns.insert({bottom:new Element("span",{"class":"smltxt infomsg"}).update((b.isMand===true?"Mandatory & ":"")+"Unique Alias")})}}b.element.insert({bottom:b.me._getAliasRow(e.id,b.aliastypebox,b.aliasTypeId,b.aliastxtbox,b.aliasbtns,b.pattern,b.sampleformat)})})});b.manTypeIds.each(function(d){b.index=b.unqiueTypeIds.indexOf(d);b.isUniq=false;if(b.index>=0){b.unqiueTypeIds.splice(b.index,1);b.isUniq=true}b.element.insert({bottom:b.me._getAliasRow("",c[d].name+' <span class="manhint">*</span>: ',d,b.me._getAliasEditBox("","Mandatory"+(b.isUniq===true?" & Unique":"")+" alias!"),(b.isUniq===true?new Element("span").insert({bottom:new Element("span",{"class":"smltxt infomsg"}).update("Mandatory & Unique Alias ")}):""),c[d].pattern.pattern,c[d].pattern.sampleformat)})});b.unqiueTypeIds.each(function(d){b.element.insert({bottom:b.me._getAliasRow("",c[d].name+": ",d,b.me._getAliasEditBox("","Unique alias!"),new Element("span").insert({bottom:b.me._getAliasDelBtn()}).insert({bottom:new Element("span",{"class":"smltxt infomsg"}).update("Unique Alias ")}),c[d].pattern.pattern,c[d].pattern.sampleformat)})});return b.element},_getSampleFormatDiv:function(b,a){return(b!==undefined&&b!==null&&!b.blank())?new Element("div",{"class":"aliaspattern smltxt",pattern:b}).update("Valid Format: "+a):""},_getAliasRow:function(d,h,f,b,e,g,a){var c={};c.patternElement=this._getSampleFormatDiv(g,a);c.element=new Element("div",{"class":"row alias",piaid:d,typeid:f}).insert({bottom:new Element("span",{"class":"title inlineblock"}).update(h)}).insert({bottom:new Element("span",{"class":"content inlineblock"}).update(b).insert({bottom:c.patternElement})}).insert({bottom:new Element("span",{"class":"info inlineblock"}).update(e)});return c.element},_getSelectBox:function(a,d,c,e){var b={};b.element=new Element("select",{"class":"roundcnr fullwidth"});a.each(function(f){b.element.insert({bottom:new Element("option",{value:f[d],selected:(f[d]===e?true:false)}).update(f[c])})});return b.element},_getRowDiv:function(e,b,d,c){var a={};a.element=new Element("div",{"class":"row"+(c!==undefined?c:"")}).insert({bottom:new Element("span",{"class":"title inlineblock"}).update(e)}).insert({bottom:new Element("span",{"class":"content inlineblock"}).update(b)});if(d!==undefined){a.element.insert({bottom:new Element("span",{"class":"info inlineblock"}).update(d)})}return a.element},_showMultiplePI:function(b){var a={};a.me=this;a.list=new Element("div",{"class":"multiResultWrapper"});a.rowNo=0;a.list.insert({bottom:a.me._getMultiDiv("","PartType","Location").addClassName("aliastyperow header")});b.each(function(c){a.list.insert({bottom:a.me._getMultiDiv(c.id,c.parttype.name,c.warehouse.path,"").addClassName("aliastyperow "+((a.rowNo++)%2===0?"even":"odd"))})});Modalbox.show(new Element("div").update(a.list),{title:'<span style="color: red;">Multiple Part Instance Found, please select which you are trying to edit:</span>',width:"800",afterLoad:function(){$(Modalbox.MBcontent).getElementsBySelector(".multipi[partinstanceid]").each(function(c){a.piId=a.piId=$(c).readAttribute("partinstanceid");c.observe("click",function(){a.me._reloadPIDetails($(this).readAttribute("partinstanceid"));Modalbox.hide()})})}})},_getMultiDiv:function(b,c,a){var d={};d.element=new Element("div",{"class":"multipi row",partinstanceid:b}).insert({bottom:new Element("span",{"class":"inlineblock multipiname"}).update(c)}).insert({bottom:new Element("span",{"class":"inlineblock multipilocation"}).update("@ "+a)});return d.element},keydown:function(c,a,b){if(!((c.which&&c.which==13)||(c.keyCode&&c.keyCode==13))){if(typeof(b)==="function"){b()}return true}if(typeof(a)==="function"){a()}return false}};